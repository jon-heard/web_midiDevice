<!doctype html>
<!--
todo
- fix bug with "value = 1 - value" (when it's non-snapped)
- add audio
-->
<html>
	<head>
		<title>VMidi controller</title>
		<style>
			body {
				color: white;
				background-color: black;
				text-align: center;
			}
			table {
				display: inline-block;
			}
		</style>
		<script src="libs/webmidi.iife.js"></script>
		<script src="libs/MouseController.js"></script>
		<script src="libs/VibratoMaker.js"></script>
	</head>
	<body>
		<button id='allOffUi'>&#128721;</button><br/><br/>

		Octave<br/><select id='globalOctaveUi'></select><br/><br/>

		<table border='1'>
			<tr><td>Row 1 (1,2,3,...)</td><td>Octave <select id='row1_OctaveUi'></select></td><td>Channel <select id='row1_channelUi'></select></td></tr>
			<tr><td>Row 2 (Q,W,E,...)</td><td>Octave <select id='row2_OctaveUi'></select></td><td>Channel <select id='row2_channelUi'></select></td></tr>
			<tr><td>Row 3 (A,S,D,...)</td><td>Octave <select id='row3_OctaveUi'></select></td><td>Channel <select id='row3_channelUi'></select></td></tr>
			<tr><td>Row 4 (Z,X,C,...)</td><td>Octave <select id='row4_OctaveUi'></select></td><td>Channel <select id='row4_channelUi'></select></td></tr>
		</table><br/><br/>

		<table border='1'>
			<tr><td>&nbsp;X&nbsp;1&nbsp;</td><td><select id='control_0_Ui'></select></td><td><select id='control_0_snapUi'></select></td><td><input id='control_0_modUi'></input></td></tr>
			<tr><td>&nbsp;Y&nbsp;1&nbsp;</td><td><select id='control_1_Ui'></select></td><td><select id='control_1_snapUi'></td><td><input id='control_1_modUi'></input></td></tr>
			<tr><td>&nbsp;X&nbsp;2&nbsp;</td><td><select id='control_2_Ui'></select></td><td><select id='control_2_snapUi'></select></td><td><input id='control_2_modUi'></input></td></tr>
			<tr><td>&nbsp;Y&nbsp;2&nbsp;</td><td><select id='control_3_Ui'></select></td><td><select id='control_3_snapUi'></td><td><input id='control_3_modUi'></input></td></tr>
		</table><br/><br/>

		<canvas id='mouseUi'></canvas><br/><br/>

		<table border='1'>
			<tr><td>Vibrato enabled</td><td><input id='vibratoEnabled' type='checkbox'></input></td></tr>
			<tr><td>Pitch range</td><td><select id='pitchRangeUi'></select></td></tr>
		</table><br/>

		<br/><br/>
		<a href='https://www.tobias-erichsen.de/software/loopmidi.html'>loopMIDI</a><br/>
		<a href='https://anotherproducer.com/online-tools-for-musicians/midi-cc-list/'>Midi controls</a><br/>
		<br/>
	</body>
</html>
<script>
	const MOUSE_UI_SIZE = 400;
	FUNCTION_KEYS = {
		192: () => { document.getElementById('globalOctaveUi').value = currentGlobalOctave = Math.min(currentGlobalOctave + 1, 8); },
		9: () => { document.getElementById('globalOctaveUi').value = currentGlobalOctave = Math.max(currentGlobalOctave - 1, 0); },
	};
	const KEYS_TO_NOTES = {
		49: ['c',0], 50: ['c#',0], 51: ['d',0], 52: ['d#',0], 53: ['e',0], 54: ['f',0], 55: ['f#',0], 56:  ['g',0], 57:  ['g#',0], 48:  ['a',0], 173: ['a#',0], 61:  ['b',0],
		81: ['c',1], 87: ['c#',1], 69: ['d',1], 82: ['d#',1], 84: ['e',1], 89: ['f',1], 85: ['f#',1], 73:  ['g',1], 79:  ['g#',1], 80:  ['a',1], 219: ['a#',1], 221: ['b',1],
		65: ['c',2], 83: ['c#',2], 68: ['d',2], 70: ['d#',2], 71: ['e',2], 72: ['f',2], 74: ['f#',2], 75:  ['g',2], 76:  ['g#',2], 59:  ['a',2], 222: ['a#',2], 13: ['b',2], 
		90: ['c',3], 88: ['c#',3], 67: ['d',3], 86: ['d#',3], 66: ['e',3], 78: ['f',3], 77: ['f#',3], 188: ['g',3], 190: ['g#',3], 191: ['a',3],
	};
	const KEYS_TO_CONTROLLER = { /*up*/38: 0, /*down*/40: 2, /*left*/37: 4, /*right*/39: 6, /*backspace*/8: 8, /*back-slash*/220: 10, /*delete*/46: 12, /*space*/32: 14, /*home*/36: 16 };
	const NOTES = ['c','c#','d','d#','e','f','f#','g','g#','a','a#'];
	const MIDI_CONTROL_SNAP_CAPTIONS = { 0:'NONE', 1:'0%', 2:'50%', 3:'100%' }
	const KEYS_TO_AXIS_PAIR = { /*shift*/16: 0, /*ctrl*/17: 1 };

	let midiChannels = [null, null, null, null];
	let currentGlobalOctave = 4;
	let keyRows = [{octave: 0, channel: 0}, {octave: 1, channel: 0}, {octave: 2, channel: 0}, {octave: 3, channel: 0}];
	let vibratoMaker;

	function onKeyDownOrUp(keyCode, isDown, channel = 0) {
		if (FUNCTION_KEYS[keyCode] && isDown) FUNCTION_KEYS[keyCode]();
		if (KEYS_TO_AXIS_PAIR[keyCode] !== undefined && isDown) {
			mouseController.setAxisPair(KEYS_TO_AXIS_PAIR[keyCode]);
		}
		if (KEYS_TO_CONTROLLER[keyCode] !== undefined) {
			midiChannels[0].sendControlChange(119, KEYS_TO_CONTROLLER[keyCode] + (isDown ? 0 : 1));
		}
		if (!KEYS_TO_NOTES[keyCode]) return;
		const note = KEYS_TO_NOTES[keyCode][0];
		const row = keyRows[KEYS_TO_NOTES[keyCode][1]];
		if (isDown) {
			midiChannels[row.channel].playNote(`${note}${currentGlobalOctave + row.octave}`, { attack: mouseController.getControlProperties(11).value });
		} else {
			midiChannels[row.channel].stopNote(`${note}${currentGlobalOctave + row.octave}`);
		}
	}

	function stopAllSound() {
		for (let channelId = 0; channelId < midiChannels.length; channelId++) {
			midiChannels[channelId].sendAllSoundOff();
			midiChannels[channelId].sendAllNotesOff();
			for (let noteId = 0; noteId < NOTES.length; noteId++) {
				for (let octaveId = 0; octaveId < 8; octaveId++) {
					midiChannels[channelId].stopNote(`${NOTES[noteId]}${octaveId}`);				
				}
			}
		}
	}

	function getVibratoEnabled(value) {
		vibratoMaker.setEnabled(value);
	}

	// Mouse input
	function onAxisValueChanged(evt) {
		const controlId = mouseController.getAxisControlId(evt.axis);
		for (let channelId = 0; channelId < midiChannels.length; channelId++) {
			switch (controlId) {
				case 128:
					vibratoMaker.setBasePitch(evt.value);
					break;
				case 129:
					vibratoMaker.setSpeed(evt.value);
					break;
				case 130:
					vibratoMaker.setDepth(evt.value);
					break;
				default:
					midiChannels[channelId].sendControlChange(controlId, Math.ceil(evt.value * 127));
					break;
			}
		}
	}
	const mouseController = new MouseController(document.getElementById('mouseUi'), MOUSE_UI_SIZE, 2);
	mouseController.addEventListener('axisValueChange', onAxisValueChanged);

	function onAxisControlChanged(axisId) {
		const controlId = parseInt(document.getElementById(`control_${axisId}_Ui`).value, 10);
		mouseController.setAxisControl(axisId, controlId);
		const controlProperties = mouseController.getAxisControlProperties(axisId);
		document.getElementById(`control_${axisId}_snapUi`).value = controlProperties.snap * 2 + 1;
		document.getElementById(`control_${axisId}_modUi`).value = controlProperties.modText;
	}

	function onAxisSnapChanged(axisId) {
		const snapValue = (parseInt(document.getElementById(`control_${axisId}_snapUi`).value, 10) - 1) * 0.5;
		mouseController.setAxisSnap(axisId, snapValue);
	}

	function onAxisModChanged(axisId) {
		mouseController.setAxisMod(axisId, document.getElementById(`control_${axisId}_modUi`).value);
	}

	(async function setupMidi() {
		// Midi channels
		await WebMidi.enable();
		const midiOut = WebMidi.getOutputByName('VMidi');
		if (!midiOut) {
			const msg = 'Midi device "VMidi" not found';
			console.error(msg);
			alert(msg);
			return;
		}
		for (let channelId = 0; channelId < midiChannels.length; channelId++) {
			midiChannels[channelId] = midiOut.channels[channelId + 1];
		}
		vibratoMaker = new VibratoMaker(midiChannels);

		// NOTE - the following event listeners are setup here as they assume WebMidi is properly initialized.  If init fails, we won't setup these listeners.
		// Keyboard (computer) input
		document.addEventListener('keydown', evt => {
			if (evt.target.tagName == 'INPUT') return;
			evt.preventDefault();
			if (evt.repeat) return;
			onKeyDownOrUp(evt.keyCode, true);
		});
		document.addEventListener('keyup', evt => {
			onKeyDownOrUp(evt.keyCode, false);
		});
		// Stop button
		document.getElementById('allOffUi').addEventListener('click', stopAllSound);
		// Vibrato enabled
		document.getElementById('vibratoEnabled').addEventListener('change', evt => getVibratoEnabled(evt.target.checked));
		document.getElementById('vibratoEnabled').checked = false;
		getVibratoEnabled(false);

		// Range select uis (populate and setup reactions)
		function setupRangeSelect(selectUi, defaultValue, maxValue, listener, minValue, captions, showCaptionsOnly) {
			selectUi = document.getElementById(selectUi);
			minValue ||= 0;
			captions ||= {};
			selectUi.innerHTML = '';
			for (i = minValue; i < maxValue + 1; i++) {
				let optionText = i;
				if (captions[i]) {
					optionText = showCaptionsOnly ? captions[i] : `${i} - ${captions[i]}`;
				}
				selectUi[selectUi.length] = new Option(optionText, i, i === defaultValue, i === defaultValue);
			}
			if (listener) {
				selectUi.addEventListener('change', listener);
			}
		}
		setupRangeSelect('globalOctaveUi', currentGlobalOctave, 8, evt => { currentGlobalOctave = parseInt(evt.target.value, 10); });
		setupRangeSelect('row1_OctaveUi',  keyRows[0].octave, 8,  evt => { keyRows[0].octave =  parseInt(evt.target.value, 10); });
		setupRangeSelect('row2_OctaveUi',  keyRows[1].octave, 8,  evt => { keyRows[1].octave =  parseInt(evt.target.value, 10); });
		setupRangeSelect('row3_OctaveUi',  keyRows[2].octave, 8,  evt => { keyRows[2].octave =  parseInt(evt.target.value, 10); });
		setupRangeSelect('row4_OctaveUi',  keyRows[3].octave, 8,  evt => { keyRows[3].octave =  parseInt(evt.target.value, 10); });
		setupRangeSelect('row1_channelUi', keyRows[0].channel, 4, evt => { keyRows[0].channel = parseInt(evt.target.value, 10); });
		setupRangeSelect('row2_channelUi', keyRows[1].channel, 4, evt => { keyRows[1].channel = parseInt(evt.target.value, 10); });
		setupRangeSelect('row3_channelUi', keyRows[2].channel, 4, evt => { keyRows[2].channel = parseInt(evt.target.value, 10); });
		setupRangeSelect('row4_channelUi', keyRows[3].channel, 4, evt => { keyRows[3].channel = parseInt(evt.target.value, 10); });
		setupRangeSelect('pitchRangeUi', 1, 12, evt => { vibratoMaker.setPitchRange(parseInt(evt.target.value, 10)); }, 1);
		for (let i = 0; i < 4; i++) {
			const axisId = i; // Store const from i for this closure
			const controlProperties = mouseController.getAxisControlProperties(axisId);
			setupRangeSelect(`control_${axisId}_Ui`, controlProperties.id, 130, evt => { onAxisControlChanged(axisId); }, 0, MIDI_CONTROL_NAMES);
			setupRangeSelect(`control_${axisId}_snapUi`, controlProperties.snap * 2 + 1, 3, evt => { onAxisSnapChanged(axisId); }, 0, MIDI_CONTROL_SNAP_CAPTIONS, true);
			document.getElementById(`control_${axisId}_modUi`).value = controlProperties.modText;
			document.getElementById(`control_${axisId}_modUi`).addEventListener('change', evt => { onAxisModChanged(axisId); });
		}
	})();

</script>
